# Quoth Supabase Vector Implementation Report

**Date:** 2026-01-11
**Status:** Complete
**Production URL:** https://quoth.ai-innovation.site

---

## Executive Summary

Transformed Quoth from a file-based document reader to a **semantic search engine** using:
- **Supabase** with pgvector for vector storage
- **Google Gemini** (text-embedding-004) for 768-dimension embeddings
- **Multi-tenant architecture** ready for multiple projects

The search now understands **meaning and context** rather than just matching keywords.

---

## Architecture Overview

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         MCP Client                               ‚îÇ
‚îÇ                    (Claude, AI Agents)                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     Quoth MCP Server                             ‚îÇ
‚îÇ                   /api/mcp (Next.js)                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ search_index‚îÇ  ‚îÇ  read_doc   ‚îÇ  ‚îÇ    propose_update       ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                ‚îÇ
          ‚ñº                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Vector Search Layer                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  Gemini API     ‚îÇ       ‚îÇ         Supabase                 ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  text-embedding ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  -004 (768d)    ‚îÇ       ‚îÇ  ‚îÇprojects ‚îÇ  ‚îÇdocument_       ‚îÇ ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇembeddings      ‚îÇ ‚îÇ ‚îÇ
‚îÇ                            ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ(768 vectors)   ‚îÇ ‚îÇ ‚îÇ
‚îÇ                            ‚îÇ  ‚îÇdocuments‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ ‚îÇ
‚îÇ                            ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îÇ ‚îÇ
‚îÇ                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Files Created/Modified

### New Files

| File | Lines | Purpose |
|------|-------|---------|
| `src/lib/supabase.ts` | 85 | Supabase client, types, project management |
| `src/lib/ai.ts` | 58 | Gemini embedding generation with rate limiting |
| `src/lib/sync.ts` | 142 | Document sync, chunking, and indexing logic |
| `scripts/index-knowledge-base.ts` | 156 | Initial indexing script for knowledge base |
| `supabase/migrations/001_vector_schema.sql` | 79 | Database schema with pgvector |

### Modified Files

# Supabase Vector Implementation (Next-Gen RAG)

This document details the vector search implementation using **Jina Embeddings v3** and **Cohere Rerank**.

## Overview

The system uses `pgvector` on Supabase to store 512-dimensional embeddings generated by Jina AI. Search is performed using a two-stage retrieval process:
1.  **Vector Search**: Using Cosine Distance to retrieve top 50 candidates.
2.  **Reranking**: Using Cohere (`rerank-english-v3.0`) to filter and reorder to the top 15 results.

## Database Schema

```sql
-- Enable the pgvector extension to work with embedding vectors
create extension if not exists vector;

-- Documents table (unchanged)
create table documents (
  id uuid default gen_random_uuid() primary key,
  project_id uuid not null references projects(id) on delete cascade,
  file_path text not null,
  title text not null,
  content text not null, -- Full markdown content
  checksum text not null, -- MD5 hash of content to detect changes
  version integer default 1,
  last_updated timestamp with time zone default timezone('utc'::text, now()) not null,
  
  -- Ensure unique path per project
  unique(project_id, file_path)
);

-- Embeddings table (Updated for Jina MRL)
create table document_embeddings (
  id uuid default gen_random_uuid() primary null,
  document_id uuid references documents(id) on delete cascade not null,
  content_chunk text not null, -- The actual text chunk used for embedding
  chunk_hash text not null, -- MD5 hash of the chunk
  embedding vector(512) not null, -- Jina v3 (Matryoshka compressed)
  metadata jsonb default '{}'::jsonb -- Stores AST metadata (function name, line numbers)
);

-- Indexing
create index on document_embeddings using hnsw (embedding vector_cosine_ops);
```

## Ingestion Pipeline (AST Chunking)

Instead of naive text splitting, we use **AST Chunking** via `tree-sitter`.
- **Code Files**: Parsed into semantic units (Functions, Classes).
- **Metadata**: Each chunk retains `startLine`, `endLine`, `type` (e.g., `function_declaration`), and parent context.
- **Fallback**: Non-code files use paragraph/header splitting.

## Search Logic (`searchDocuments`)

1.  **Embed Query**: `ai.ts` calls Jina API (`task: retrieval.query`) -> 512d vector.
2.  **Vector Match**: Supabase RPC `match_documents` finds 50 nearest neighbors.
3.  **Rerank**: Cohere API scores the relevance of the 50 chunks against the query.
4.  **Format**: Results are augmented with `trust` scores (HIGH/MEDIUM/LOW) for consumption by Gemini 2.0.

## Environment Variables

Required keys for this architecture:
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY` (for indexing)
- `JINA_API_KEY` (for embeddings)
- `COHERE_API_KEY` (for reranking)
- `GEMINIAI_API_KEY` (as fallback or for generation)
**After:** Supabase query with fuzzy matching

Supports lookup by:
- Document title (e.g., `pattern-backend-unit`)
- File path (e.g., `patterns/backend-unit-vitest.md`)
- Partial match (e.g., `backend-unit`)

### `quoth_propose_update` (Unchanged)

Still logs proposals for human review. Future enhancement: Store in Supabase.

---

## Indexing Script

### Usage

```bash
npx tsx scripts/index-knowledge-base.ts
```

### Process

1. Load environment from `.env.local`
2. Create/get project in Supabase
3. Scan `quoth-knowledge-base/` for markdown files
4. For each file:
   - Calculate MD5 checksum
   - Skip if unchanged (checksum match)
   - Parse frontmatter with gray-matter
   - Upsert document record
   - Delete old embeddings
   - Chunk by H2 headers
   - Generate Gemini embeddings (with 4s delay)
   - Insert new embeddings

### Output Example

```
ü¶Ö Quoth Knowledge Base Indexer

üìÅ Project: quoth-knowledge-base
   Created new project: b6fc48df-f192-49ea-b9b6-f86d53c69c47

üìÑ Found 10 markdown files

[1/10] architecture/backend-repo-structure.md
   üìä 4 chunks to embed
   ‚úÖ Indexed 4 chunks
...

==================================================
üìä Indexing Complete
   Files processed: 10
   Files skipped (unchanged): 0
   Total chunks indexed: 46
==================================================
```

---

## Environment Variables

| Variable | Description | Required |
|----------|-------------|----------|
| `NEXT_PUBLIC_SUPABASE_URL` | Supabase project URL | Yes |
| `SUPABASE_SERVICE_ROLE_KEY` | Service role key (write access) | Yes |
| `GEMINIAI_API_KEY` | Google AI Studio API key | Yes |
| `GOOGLE_API_KEY` | Fallback for Gemini API | No |
| `QUOTH_PROJECT_SLUG` | Default project slug | No (default: `quoth-knowledge-base`) |

---

## Search Configuration

```typescript
const SEARCH_CONFIG = {
  matchThreshold: 0.65,  // Minimum similarity score (0-1)
  matchCount: 10,        // Maximum results to return
};
```

---

## Performance Characteristics

### Indexing Performance
- ~4 seconds per chunk (Gemini rate limit)
- 46 chunks indexed in ~3 minutes
- Incremental: unchanged files are skipped

### Search Performance
- Query embedding: ~200ms
- Supabase RPC: ~50ms
- Total: ~250ms per search

### Storage
- 768 floats per embedding √ó 4 bytes = ~3KB per chunk
- 46 chunks √ó 3KB = ~138KB for current knowledge base
- Supabase free tier: 500MB (sufficient for ~100,000 chunks)

---

## Testing Results

### Local Testing

```bash
# Tools list
curl -X POST http://localhost:3000/api/mcp \
  -H "Accept: application/json, text/event-stream" \
  -d '{"jsonrpc":"2.0","id":1,"method":"tools/list"}'
# ‚úÖ Returns 3 tools

# Semantic search
curl -X POST http://localhost:3000/api/mcp \
  -d '{"method":"tools/call","params":{"name":"quoth_search_index","arguments":{"query":"how to mock dependencies"}}}'
# ‚úÖ Returns pattern-backend-unit (72% match)

# Read document
curl -X POST http://localhost:3000/api/mcp \
  -d '{"method":"tools/call","params":{"name":"quoth_read_doc","arguments":{"doc_id":"pattern-backend-unit"}}}'
# ‚úÖ Returns full document content
```

### Production Testing

```bash
curl -X POST https://quoth.ai-innovation.site/api/mcp \
  -H "Accept: application/json, text/event-stream" \
  -d '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"quoth_search_index","arguments":{"query":"playwright e2e testing"}}}'
# ‚úÖ Returns pattern-frontend-e2e (67% match)
```

---

## Commits

1. **50dfb48** - `feat: Implement Supabase vector search with Gemini embeddings`
   - Core implementation of all services
   - SQL schema and migrations
   - Updated MCP tools

2. **d9a2aa1** - `docs: Update CLAUDE.md with Supabase vector architecture`
   - Documentation updates

---

## Future Enhancements

1. **GitHub Webhook Integration**
   - Auto-reindex on push to main
   - Webhook endpoint at `/api/webhooks/github`

2. **Proposal Storage in Supabase**
   - Store `quoth_propose_update` proposals in database
   - Add approval workflow

3. **Multi-Project Dashboard**
   - Web UI to manage multiple projects
   - View indexed documents and search history

4. **Improved Chunking**
   - Consider code block boundaries
   - Semantic chunking based on content

5. **Caching Layer**
   - Cache frequent queries
   - Reduce Gemini API calls

---

## Troubleshooting

### "Supabase not configured"
Ensure environment variables are set:
```bash
vercel env pull .env.local --environment=production
```

### "Project not found"
Run the indexing script:
```bash
npx tsx scripts/index-knowledge-base.ts
```

### "Gemini API rate limit"
The script includes 4s delays. For large batches, increase delay:
```typescript
// In ai.ts
delayMs: 5000 // 12 requests per minute
```

### Empty search results
Lower the match threshold:
```typescript
// In search.ts
matchThreshold: 0.5 // More permissive
```

---

## Dependencies Added

```json
{
  "dependencies": {
    "@google/generative-ai": "^0.24.0",
    "@supabase/supabase-js": "^2.49.4"
  },
  "devDependencies": {
    "dotenv": "^17.2.3",
    "tsx": "^4.20.3"
  }
}
```

---

## Conclusion

Quoth now provides **intelligent semantic search** that understands developer intent. The query "how to mock dependencies in vitest tests" correctly returns the Vitest mocking patterns document with 72% similarity, compared to the previous keyword-based approach that would have required exact term matches.

The architecture is:
- **Scalable**: Supabase handles vector operations efficiently
- **Cost-effective**: Free tiers for both Supabase and Gemini
- **Multi-tenant ready**: Projects table supports multiple knowledge bases
- **Incremental**: Only changed documents are re-indexed
